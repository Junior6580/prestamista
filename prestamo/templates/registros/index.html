{% extends "base.html" %}
    {% block titulo %} Lista de Prestamos {% endblock %}
    {% block contenido %}
    <br /><br />
    <div class="row">
        <div class="col-6 mx-auto">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-dismissible alert-success">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <strong class="text-dark">{{ message }}</strong>
            </div>
            {% endfor %}
            {% endif %}
            <div class="card">
                <div class="card-body">
                    <h2>Registro de prestamos</h2>

                    <form action="/nuevo_prestamo/" method="POST">{% csrf_token %}
                        <div class="mb-3">
                            <label for="cliente">Cliente</label>
                            <select name="cliente" id="cliente" class="form-select" required />
                            <option value="" selected="selected">Seleccionar un cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for "prestamo">Préstamo</label>
                            <input type="text" class="form-control" name="prestamo" id="prestamo" required />
                        </div>

                        <div class="mb-3">
                            <label for "cantidad_cuotas">Cantidad de Cuotas</label>
                            <input type="number" class="form-control" value="" name="cantidad_cuotas"
                                id="cantidad_cuotas" required />
                        </div>

                        <div class="mb-3">
                            <label for="frecuencia_pago">Frecuencia de Pago</label>
                            <select name="frecuencia_pago" id="frecuencia_pago" class="form-select" required>
                                <option value="">Seleccione</option>
                                <option value="diario">Diario</option>
                                <option value="ocho_dias">Cada ocho días</option>
                                <option value="quince_dias">Cada quince días</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for "fecha_prestamo">Fecha de Préstamo</label>
                            <input type="date" class="form-control" name="fecha_prestamo" id="fecha_prestamo" readonly />
                        </div>

                        <div class="mb-3">
                            <label for "fecha_fin">Fecha de Fin</label>
                            <input type="date" class="form-control" name="fecha_fin" id="fecha_fin" readonly />
                        </div>

                        <div class="mb-3">
                            <label for="fecha_cuota">Fecha de Próxima Cuota</label>
                            <input type="date" class="form-control" name="fecha_cuota" id="fecha_cuota" readonly />
                        </div>
                        

                        <div class="mb-3">
                            <label for="tasa_interes">Tasa de Interés</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="tasa_interes" id="tasa_interes" readonly />
                                <button class="btn btn-outline-dark" type="button"> <i
                                        class="fa-solid fa-percent"></i></button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for "valor_cuota">Valor cuota</label>
                            <input type="text" class="form-control" value="0" name="valor_cuota" id="valor_cuota"
                                readonly />
                        </div>

                        <div class="mb-3">
                            <label for "debe">Debe</label>
                            <input type="text" class="form-control" value="0" name="debe" id="debe"
                                readonly />
                        </div>
                        <div class="mb-3">
                            <input class="form-control" type="hidden" value="0" name="pagado" id="pagado" disabled
                                readonly>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-success btn-block text-white">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
            <br /><br />
        </div>
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h1>Listado de Prestamos</h1>
                    <table id="datatable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Cliente ID</th>
                                <th scope="col">Fecha Prestamo</th>
                                <th scope="col">Fecha Fin</th>
                                <th scope="col">Fecha Cuota</th>
                                <th scope="col">Valor</th>
                                <th scope="col">Cantidad de cuotas</th>
                                <th scope="col">Frecuencia de pago</th>
                                <th scope="col">Tasa Interes</th>
                                <th scope="col">Cuota</th>
                                <th scope="col">Debe</th>
                                <th scope="col">Pagado</th>

                            </tr>
                        </thead>
                        <tbody>
                            {% for Prestamo in prestamos %}
                            <tr>
                                <td>{{ Prestamo.id }}</td>
                                <td>{{ Prestamo.cliente }}</td>
                                <td>{{ Prestamo.fecha_prestamo }}</td>
                                <td>{{ Prestamo.fecha_fin }}</td>
                                <td>
                                    {% if Prestamo.fecha_cuota %}
                                      {{ Prestamo.fecha_cuota }}
                                    {% else %}
                                      <span class="text-muted">No se ha establecido</span>
                                    {% endif %}
                                  </td>
                                <td>{{ Prestamo.prestamo }}</td>
                                <td>{{ Prestamo.cantidad_cuotas }}</td>
                                <td>{{ Prestamo.frecuencia_pago }}</td>
                                <td>{{ Prestamo.tasa_interes }}</td>
                                <td>{{ Prestamo.valor_cuota }}</td>
                                <td>{{ Prestamo.debe }}</td>
                                <td>{{ Prestamo.pagado }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        var cantidadCuotasInput = document.getElementById("cantidad_cuotas");

        // Agrega un evento de cambio al campo de cantidad de cuotas
        cantidadCuotasInput.addEventListener("input", function() {
            // Llama a las funciones necesarias para recalcular los valores
            calcularFechaFin();
            calcularDeuda();
            calcularcuota();
        });

        var frecuenciaPagoInput = document.getElementById("frecuencia_pago");
        frecuenciaPagoInput.addEventListener("change", calcularFechaFin);
        
        function calcularFechaFin() {
            var cantidadCuotas = parseInt(cantidadCuotasInput.value);
            var frecuenciaPago = frecuenciaPagoInput.value;
            var fechaPrestamo = new Date(fechaPrestamoInput.value);
        
            if (cantidadCuotas > 0 && frecuenciaPago !== "") {
                var diasFrecuencia = 0; // Cambiar según la frecuencia seleccionada
        
                if (frecuenciaPago === "diario") {
                    diasFrecuencia = 1;
                }else if (frecuenciaPago === "ocho_dias") {
                    diasFrecuencia = 8;
                } else if (frecuenciaPago === "quince_dias") {
                    diasFrecuencia = 15;
                } else if (frecuenciaPago === "mensual") {
                    diasFrecuencia = 30; // Asumiendo un mes de 30 días
                }
        
                // Si la fecha actual es 2023-01-01 y la frecuencia es diario,
                // la primera cuota debería ser el 2023-01-02
                fechaPrestamo.setDate(fechaPrestamo.getDate() + 1);
        
                var fechaFin = new Date(fechaPrestamo);
                fechaFin.setDate(fechaFin.getDate() + (cantidadCuotas - 1) * diasFrecuencia);
        
                // Actualiza el campo "Fecha de Fin" con el resultado
                fechaFinInput.value = fechaFin.toISOString().split('T')[0];
        
                // Calcula la fecha de la próxima cuota (comienza a partir de la siguiente fecha)
                var fecha_cuota = new Date(fechaPrestamo);
                fecha_cuota.setDate(fecha_cuota.getDate());
                document.getElementById("fecha_cuota").value = fecha_cuota.toISOString().split('T')[0];
            }
        }
        
        frecuenciaPagoInput.addEventListener("change", calcularFechaFin);
        


        // Obtén los elementos de fecha de préstamo y fecha de fin
        var fechaPrestamoInput = document.getElementById("fecha_prestamo");
        var fechaFinInput = document.getElementById("fecha_fin");
        var tasaInteresInput = document.getElementById("tasa_interes");

        // Agrega un evento de cambio a los campos de fecha
        fechaPrestamoInput.addEventListener("change", calcularTasaInteres);
        fechaFinInput.addEventListener("change", calcularTasaInteres);

        window.addEventListener("DOMContentLoaded", function() {
            var fechaActual = new Date();
            // Ajusta la fecha al huso horario de Colombia (UTC-5)
            fechaActual.setHours(fechaActual.getHours() - 5);
            var fechaActualString = fechaActual.toISOString().split('T')[0];
            fechaPrestamoInput.value = fechaActualString;
            calcularTasaInteres(); // Llama a la función de cálculo de tasa de interés
        });

        function calcularTasaInteres() {
            // Obtiene las fechas de préstamo y fin
            var fechaPrestamo = new Date(fechaPrestamoInput.value);
            var fechaFin = new Date(fechaFinInput.value);

            // Calcula la diferencia en meses
            var diferenciaMeses = (fechaFin - fechaPrestamo) / (1000 * 60 * 60 * 24 * 30.44);

            // Establece la tasa de interés según la diferencia en meses
            if (diferenciaMeses >= 3) {
                tasaInteresInput.value = "10";
            } else {
                tasaInteresInput.value = "5";
            }
        }

        // Obtén los elementos de préstamo, cantidad de cuotas, tasa de interés y debe
        var prestamoInput = document.getElementById("prestamo");
        var cantidadCuotasInput = document.getElementById("cantidad_cuotas");
        var tasaInteresInput = document.getElementById("tasa_interes");
        var debeInput = document.getElementById("debe");
        var valor_cuotaInput = document.getElementById("valor_cuota");

        // Agrega eventos de cambio a los campos de préstamo, cantidad de cuotas y tasa de interés
        prestamoInput.addEventListener("input", function() {
            calcularDeuda();
            calcularcuota();
        });
        cantidadCuotasInput.addEventListener("input", function() {
            calcularDeuda();
            calcularcuota();
        });
        tasaInteresInput.addEventListener("input", function() {
            calcularDeuda();
            calcularcuota();
        });

        function calcularDeuda() {
            var prestamo = parseFloat(prestamoInput.value);
            var cantidadCuotas = parseInt(cantidadCuotasInput.value);
            var tasaInteres = parseFloat(tasaInteresInput.value) / 100;
    
            // Calcula el valor adeudado
            var deuda = prestamo;
    
            for (var i = 1; i <= cantidadCuotas; i++) {
                deuda += deuda * tasaInteres;
            }
    
            // Actualiza el campo "Debe" con el resultado
            debeInput.value = deuda.toFixed(2);
        }
    
        function calcularcuota() {
            var cantidadCuotas = parseFloat(cantidadCuotasInput.value);
            var debe = parseFloat(debeInput.value);
    
            if (cantidadCuotas > 0) {
                var cuota = debe / cantidadCuotas;
                valor_cuotaInput.value = cuota.toFixed(2);
            }
        }
    
        // Llama a la función de cálculo inicial al cargar la página
        calcularDeuda();
    </script>
    {% endblock %}